# Streamlit Dashboard

A Streamlit dashboard for visualizing sleep quality data, environmental readings (temperature, humidity, light), and sleep sessions from DynamoDB. Can be run locally or deployed to AWS using ECS Express.

## Setup

1. Ensure your local AWS credentials can read DynamoDB (profile/region from your local config).
2. Create a `.env` file (you can copy from `.env.example`):

```
TABLE_NAME=<your-deployed-DynamoDB-table-name>
```

To find the physical table name quickly:

```
aws dynamodb list-tables --output table
# or, if you know the stack name:
aws cloudformation describe-stack-resources \
  --stack-name <your-backend-stack-name> \
  --logical-resource-id EnvReadingsTable \
  --query 'StackResources[0].PhysicalResourceId' --output text
```

## Install & Run (uv)

Inside this `streamlit/` directory:

```
uv sync
uv run task app
```

Alternatively:

```
uv run streamlit run app.py
```

## Features
- Date picker (defaults to today UTC)
- Bucket size: 5 minutes or 1 hour
- Percentiles: P50, P90, P99, Max (Average always shown)
- Summary for timeframe: min, max, std (temperature and humidity)

## Notes
- Table schema expected:
  - Partition key `day` (string, `YYYY-MM-DD` UTC)
  - Sort key `ts_min` (number, epoch minutes)
  - Attributes: `temp_c` (number), `humidity_pct` (number)

---

## AWS Deployment (ECS Express)

Deploy the Streamlit dashboard to AWS using ECS Express mode with automatic load balancing, SSL/TLS, and auto-scaling.

### Prerequisites

1. AWS CLI configured with appropriate credentials
2. AWS SAM CLI installed
3. Docker installed and running
4. Backend stack already deployed (`sleep-quality-advisor-backend`)

### Architecture

- **Service**: ECS Express (Fargate-based)
- **Compute**: 0.5 vCPU, 1 GB RAM
- **Auto-scaling**: 1-2 tasks based on CPU (70%)
- **Load Balancer**: Automatic ALB with SSL/TLS
- **Container Registry**: ECR
- **Authentication**: Username/password stored in Secrets Manager
- **Logs**: CloudWatch Logs (7-day retention)

### Deployment Steps

#### 1. Deploy Infrastructure (First Time)

```bash
# Deploy SAM template (creates ECR, ECS cluster, IAM roles, secrets, etc.)
uv run task deploy-infra
```

This creates:
- ECR repository for Docker images
- ECS Express service with ALB
- Secrets Manager secret (auto-generated credentials)
- IAM roles and policies
- CloudWatch log group

#### 2. Build and Push Docker Image

```bash
# Build Docker image, tag it, and push to ECR
uv run task deploy-image
```

Or run steps individually:
```bash
uv run task ecr-login      # Login to ECR
uv run task build-image    # Build Docker image
uv run task tag-image      # Tag with ECR URI
uv run task push-image     # Push to ECR
```

#### 3. Full Deployment (Infrastructure + Image)

```bash
# Deploy everything in one command
uv run task deploy-all
```

### Post-Deployment

#### Get Service URL

```bash
uv run task get-url
```

The URL will be in the format: `https://xxxxxx.ecs-express.us-east-1.amazonaws.com`

**Note**: It may take 2-3 minutes for the service to become fully available after deployment.

#### Get Login Credentials

```bash
uv run task get-password
```

This displays:
```
Username: admin
Password: <auto-generated-32-character-password>
```

**Save these credentials** - you'll need them to log into the dashboard.

#### Monitor Logs

```bash
# View CloudWatch logs
aws logs tail /ecs/streamlit-dashboard --follow
```

### Updating the Application

After making code changes:

```bash
# Rebuild and push new image
uv run task deploy-image

# Force new deployment (optional - ECS Express auto-updates)
aws ecs update-service \
  --cluster streamlit-dashboard-cluster \
  --service streamlit-dashboard \
  --force-new-deployment
```

### Updating Infrastructure

After modifying `template.yaml`:

```bash
uv run task deploy-infra
```

### Authentication

The dashboard includes username/password authentication:
- Credentials are auto-generated and stored in AWS Secrets Manager
- Login page appears before accessing the dashboard
- Session persists during browser session
- Logout button in sidebar

### Cost Estimate

Monthly costs (assuming 24/7 operation):
- **ECS Fargate** (0.5 vCPU, 1 GB): ~$16/month
- **Application Load Balancer**: ~$16/month
- **Data transfer**: ~$1-2/month
- **CloudWatch Logs**: <$1/month
- **Secrets Manager**: $0.40/month
- **ECR storage**: ~$0.10/month

**Total**: ~$33-35/month

With auto-scaling to 0 during idle periods (requires additional configuration), costs can be reduced significantly.

### Troubleshooting

#### Service won't start
```bash
# Check service events
aws ecs describe-services \
  --cluster streamlit-dashboard-cluster \
  --services streamlit-dashboard \
  --query 'services[0].events[:5]'

# Check CloudWatch logs
aws logs tail /ecs/streamlit-dashboard --since 10m
```

#### Can't push to ECR
```bash
# Re-authenticate with ECR
uv run task ecr-login
```

#### Cross-stack reference errors
Ensure backend stack is deployed and has the required exports:
```bash
aws cloudformation list-exports | grep sleep-quality-advisor-backend
```

Should show:
- `sleep-quality-advisor-backend-EnvReadingsTable`
- `sleep-quality-advisor-backend-SleepSessionsTable`

### Cleanup

To remove all AWS resources:

```bash
# Delete the stack (this removes everything except ECR images)
aws cloudformation delete-stack --stack-name sleep-quality-advisor-streamlit

# Delete ECR images (optional)
aws ecr batch-delete-image \
  --repository-name sleep-quality-advisor-streamlit \
  --image-ids imageTag=latest
```

